{% extends "base.html" %}

{% block title %}Video Viewer - ONVIF DVR Viewer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-3">
        <a href="/cameras" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to DVRs
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-9">
        <!-- Video Player -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0" id="cameraTitle">DVR Stream</h5>
            </div>
            <div class="card-body">
                <div class="ratio ratio-16x9 bg-dark position-relative">
                    <video id="videoPlayer" controls autoplay muted class="w-100">
                        Your browser does not support the video tag.
                    </video>
                    <div id="loadingOverlay" class="position-absolute top-50 start-50 translate-middle text-white" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-2">Starting stream...</div>
                    </div>
                </div>
                <div class="mt-2" id="streamStatus">
                    <small class="text-muted">No stream active</small>
                </div>
                <div class="mt-3">
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-success" id="playBtn" onclick="startStream()">
                            <i class="bi bi-play-fill"></i> Play
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="pauseStream()">
                            <i class="bi bi-pause-fill"></i> Pause
                        </button>
                        <button class="btn btn-sm btn-danger" id="stopBtn" onclick="stopStream()" disabled>
                            <i class="bi bi-stop-fill"></i> Stop
                        </button>
                    </div>
                    <div class="btn-group ms-2" role="group">
                        <button class="btn btn-sm btn-primary" onclick="takeSnapshot()">
                            <i class="bi bi-camera"></i> Snapshot
                        </button>
                        <button class="btn btn-sm btn-danger" id="recordBtn" onclick="toggleRecording()">
                            <i class="bi bi-record-circle"></i> Record
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PTZ Controls (if available) -->
        <div class="card" id="ptzCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">PTZ Controls</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                            <div class="text-center">
                                <div>
                                    <button class="btn btn-primary" onclick="ptzMove('up')">
                                        <i class="bi bi-arrow-up"></i>
                                    </button>
                                </div>
                                <div>
                                    <button class="btn btn-primary me-2" onclick="ptzMove('left')">
                                        <i class="bi bi-arrow-left"></i>
                                    </button>
                                    <button class="btn btn-secondary" onclick="ptzStop()">
                                        <i class="bi bi-stop-circle"></i>
                                    </button>
                                    <button class="btn btn-primary ms-2" onclick="ptzMove('right')">
                                        <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                                <div>
                                    <button class="btn btn-primary" onclick="ptzMove('down')">
                                        <i class="bi bi-arrow-down"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Zoom</label>
                            <div class="d-flex">
                                <button class="btn btn-sm btn-primary me-2" onclick="ptzZoom('in')">
                                    <i class="bi bi-zoom-in"></i> Zoom In
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="ptzZoom('out')">
                                    <i class="bi bi-zoom-out"></i> Zoom Out
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Presets</label>
                            <select class="form-select" id="ptzPresets" onchange="gotoPreset()">
                                <option value="">Select Preset...</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3">
    <!-- DVR Info -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">DVR Information</h6>
            </div>
            <div class="card-body" id="cameraInfo">
                <!-- DVR info will be loaded here -->
            </div>
        </div>

        <!-- Streams -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Video Streams</h6>
            </div>
            <div class="card-body">
                <div class="list-group" id="streamsList">
                    <!-- Streams will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Profiles -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Supported Profiles</h6>
            </div>
            <div class="card-body">
                <div id="profilesList">
                    <!-- Profiles will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- HLS.js for video playback -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
const cameraId = {{ camera_id }};
let currentStream = null;
let currentStreamId = null;
let currentProfileToken = null;
let currentStreamLabel = null;
let isRecording = false;
let hls = null;

$(document).ready(function() {
    loadCameraInfo();
    loadStreams();
    loadProfiles();
    loadPTZPresets();
});

function loadCameraInfo() {
    $.get(`/api/cameras/${cameraId}`, function(camera) {
    $('#cameraTitle').text(`${camera.name} DVR`);
        
        const info = `
            <table class="table table-sm">
                <tr><th>Host:</th><td>${camera.host}:${camera.port}</td></tr>
                <tr><th>Manufacturer:</th><td>${camera.manufacturer || 'N/A'}</td></tr>
                <tr><th>Model:</th><td>${camera.model || 'N/A'}</td></tr>
                <tr><th>Firmware:</th><td>${camera.firmware_version || 'N/A'}</td></tr>
                <tr><th>Status:</th><td>
                    <span class="badge ${camera.status === 'online' ? 'bg-success' : 'bg-secondary'}">
                        ${camera.status}
                    </span>
                </td></tr>
            </table>
        `;
        $('#cameraInfo').html(info);
    });
}

function loadStreams() {
    $.get(`/api/cameras/${cameraId}/streams`, function(streams) {
        const list = $('#streamsList');
        list.empty();
        
        if (streams.length === 0) {
            list.html('<p class="text-muted mb-0">No streams available</p>');
            return;
        }
        
        streams.forEach((stream, index) => {
            const resolution = stream.resolution ? JSON.parse(stream.resolution) : {};
            const details = [];
            if (resolution.width && resolution.height) {
                details.push(`${resolution.width}x${resolution.height}`);
            }
            if (stream.framerate) {
                details.push(`${stream.framerate}fps`);
            }
            const metaText = details.join(' @ ');
            const streamLabel = stream.stream_label || `Channel ${stream.channel_number || index + 1}`;
            const item = `
                <a href="#" class="list-group-item list-group-item-action ${index === 0 ? 'active' : ''}" 
                   data-uri="${stream.stream_uri}" 
                   data-profile="${stream.profile_token}"
                   data-label="${streamLabel.replace(/"/g, '&quot;')}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${streamLabel}</h6>
                        <small>${stream.codec || ''}</small>
                    </div>
                    <small>${metaText}</small>
                </a>
            `;
            list.append(item);
        });
        
        list.off('click', '.list-group-item').on('click', '.list-group-item', function(event) {
            event.preventDefault();
            const $item = $(this);
            selectStream($item.data('uri'), $item.data('profile'), $item, {
                label: $item.data('label')
            });
        });

        // Auto-select and start first stream
        if (streams.length > 0) {
            const $first = list.find('.list-group-item').first();
            selectStream($first.data('uri'), $first.data('profile'), $first, { autoStart: true, force: true, label: $first.data('label') });
        }
    });
}

function loadProfiles() {
    $.get(`/api/cameras/${cameraId}/profiles`, function(profiles) {
        const list = $('#profilesList');
        list.empty();
        
        if (profiles.length === 0) {
            list.html('<p class="text-muted mb-0">No profiles detected</p>');
            return;
        }
        
        profiles.forEach(profile => {
            const badge = `
                <span class="badge bg-primary me-1 mb-1">
                    ${profile.profile_name || profile.profile_token}
                </span>
            `;
            list.append(badge);
            
            // Check if PTZ is available
            const ptzConfig = profile.ptz_config ? JSON.parse(profile.ptz_config) : null;
            if (ptzConfig && ptzConfig.token) {
                $('#ptzCard').show();
            }
        });
    });
}

function loadPTZPresets() {
    $.get(`/api/cameras/${cameraId}/ptz/presets`, function(presets) {
        const select = $('#ptzPresets');
        select.find('option:not(:first)').remove();
        
        presets.forEach(preset => {
            select.append(`<option value="${preset.token}">${preset.preset_name || preset.token}</option>`);
        });
    });
}

function selectStream(uri, profileToken, $element, options = {}) {
    const settings = Object.assign({ autoStart: true, force: false, label: null }, options);

    if (!uri || !profileToken) {
        return;
    }

    const proceed = () => {
        currentStream = uri;
        currentProfileToken = profileToken;
        currentStreamLabel = settings.label || null;
        if ($element && $element.length) {
            $('#streamsList .list-group-item').removeClass('active');
            $element.addClass('active');
        }
        const label = currentStreamLabel || 'Stream';
        updateStreamStatus(`Preparing ${label}...`);

        if (settings.autoStart) {
            startStream();
        }
    };

    if (currentStreamId) {
        if (currentProfileToken === profileToken && !settings.force) {
            if (settings.autoStart) {
                startStream();
            }
            return;
        }

        updateStreamStatus('Switching stream...');
        stopStream(true).always(proceed);
    } else {
        proceed();
    }
}

function startStream() {
    if (!currentProfileToken) {
        alert('Please select a stream first');
        return $.Deferred().reject().promise();
    }

    const label = currentStreamLabel || 'stream';
    $('#loadingOverlay').show();
    $('#playBtn').prop('disabled', true);
    updateStreamStatus(`Starting ${label}...`);

    const request = $.ajax({
        url: '/api/streams/start',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            camera_id: cameraId,
            profile_token: currentProfileToken
        })
    });

    request.done(function(response) {
        currentStreamId = response.stream_id;
        const playlistUrl = response.playlist_url;

        console.log('Stream started:', response);

        if (response.already_running) {
            updateStreamStatus(`Connecting to existing ${label}...`);
        } else {
            updateStreamStatus(`Waiting for ${label} to initialize...`);
        }

        // Poll for playlist availability instead of fixed delay for faster startup
        if (response.already_running) {
            // Stream already running, start immediately
            initHLSPlayer(playlistUrl);
        } else {
            // Poll for playlist file to be created (check every 200ms, max 3 seconds)
            let pollCount = 0;
            const maxPolls = 15; // 15 * 200ms = 3 seconds max wait
            const pollInterval = setInterval(() => {
                pollCount++;
                fetch(playlistUrl, { method: 'HEAD', cache: 'no-cache' })
                    .then(response => {
                        if (response.ok) {
                            clearInterval(pollInterval);
                            initHLSPlayer(playlistUrl);
                        } else if (pollCount >= maxPolls) {
                            clearInterval(pollInterval);
                            // Timeout - try anyway, might work
                            initHLSPlayer(playlistUrl);
                        }
                    })
                    .catch(() => {
                        if (pollCount >= maxPolls) {
                            clearInterval(pollInterval);
                            // Timeout - try anyway
                            initHLSPlayer(playlistUrl);
                        }
                    });
            }, 200); // Check every 200ms
        }

        $('#stopBtn').prop('disabled', false);
    }).fail(function(xhr) {
        $('#loadingOverlay').hide();
        $('#playBtn').prop('disabled', false);
        const error = xhr.responseJSON?.error || 'Unknown error';
        alert('Failed to start stream: ' + error);
        updateStreamStatus(`Error starting ${label}`);
    });

    return request;
}

function initHLSPlayer(playlistUrl) {
    const video = document.getElementById('videoPlayer');
    
    // Clean up existing player
    if (hls) {
        hls.destroy();
    }
    
    if (Hls.isSupported()) {
        hls = new Hls({
            debug: false,
            enableWorker: true,
            lowLatencyMode: true,
            // ULTRA LOW LATENCY - Real-time viewing optimized
            maxBufferLength: 1,         // Only 1 second buffer (minimal delay)
            maxMaxBufferLength: 1.5,    // Absolute max 1.5 seconds
            backBufferLength: 0.2,      // Minimal back buffer (0.2 seconds)
            maxBufferSize: 2 * 1000 * 1000,  // 2MB max buffer (ultra low memory)
            maxBufferHole: 0.2,         // Allow very small gaps
            highBufferWatchdogPeriod: 0.5, // Check buffer every 0.5s (very aggressive)
            nudgeOffset: 0.05,         // Very small nudge for sync
            nudgeMaxRetry: 1,           // Minimal retries (faster recovery)
            maxFragLoadingTimeOut: 1,   // 1s timeout for segments (faster failover)
            fragLoadingTimeOut: 0.5,    // 0.5s timeout per fragment (ultra fast)
            manifestLoadingTimeOut: 0.5,  // 0.5s for manifest (very fast updates)
            levelLoadingTimeOut: 0.5,     // 0.5s for level
            // Real-time optimizations
            capLevelToPlayerSize: true,  // Don't exceed player size
            autoStartLoad: true,         // Start loading immediately
            startPosition: -1,           // Start from live edge
            liveSyncDurationCount: 0.5,    // Sync to 0.5 segments behind live (minimal delay)
            liveMaxLatencyDurationCount: 1, // Max 1 segment behind (1 second max)
            liveDurationInfinity: true,   // Live stream mode
            liveBackBufferLength: 0.2,    // Minimal live back buffer (0.2 seconds)
            // Aggressive real-time settings
            maxLiveSyncPlaybackRate: 1.5, // Allow slight speedup to catch up
            maxLiveSyncPlaybackRateOffset: 0.5, // Speedup offset
            // Network optimizations for real-time
            xhrSetup: function(xhr, url) {
                xhr.withCredentials = false;
                xhr.timeout = 800;       // 0.8s timeout (ultra fast)
            },
            // Playlist refresh for real-time updates
            manifestLoadingMaxRetry: 2,
            manifestLoadingRetryDelay: 500,  // 500ms retry delay
            levelLoadingMaxRetry: 2,
            levelLoadingRetryDelay: 500,
            fragLoadingMaxRetry: 2,
            fragLoadingRetryDelay: 500
        });
        
        hls.loadSource(playlistUrl);
        hls.attachMedia(video);
        
        // Force immediate playback for real-time viewing
        video.addEventListener('loadedmetadata', function() {
            // Seek to live edge immediately
            if (video.seekable.length > 0) {
                video.currentTime = video.seekable.end(video.seekable.length - 1);
            }
        }, { once: true });
        
        hls.on(Hls.Events.MANIFEST_PARSED, function() {
            // Start playing immediately without waiting for buffer
            video.play().catch(function(e) {
                console.log('Auto-play prevented, user interaction required');
            });
            
            // Continuously seek to live edge for real-time viewing
            const liveSyncInterval = setInterval(function() {
                if (video.seekable.length > 0) {
                    const liveEdge = video.seekable.end(video.seekable.length - 1);
                    const currentTime = video.currentTime;
                    const delay = liveEdge - currentTime;
                    
                    // If more than 0.5 seconds behind, jump to live edge
                    if (delay > 0.5) {
                        video.currentTime = liveEdge;
                    }
                }
            }, 200); // Check every 200ms (more frequent sync)
            
            // Store interval for cleanup
            hls.liveSyncInterval = liveSyncInterval;
            
            $('#loadingOverlay').hide();
            $('#playBtn').prop('disabled', false);
            updateStreamStatus('Playing live...');
        });
        
        hls.on(Hls.Events.ERROR, function(event, data) {
            console.error('HLS error:', data);
            if (data.fatal) {
                switch(data.type) {
                    case Hls.ErrorTypes.NETWORK_ERROR:
                        console.log('Network error - attempting to recover');
                        hls.startLoad();
                        break;
                    case Hls.ErrorTypes.MEDIA_ERROR:
                        console.log('Media error - attempting to recover');
                        hls.recoverMediaError();
                        break;
                    default:
                        console.error('Fatal error - cannot recover');
                        hls.destroy();
                        updateStreamStatus('Playback error');
                        break;
                }
            }
        });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // Native HLS support (Safari)
        video.src = playlistUrl;
        video.addEventListener('loadedmetadata', function() {
            video.play();
            $('#loadingOverlay').hide();
            $('#playBtn').prop('disabled', false);
            updateStreamStatus('Playing...');
        });
    } else {
        alert('HLS is not supported in your browser');
        $('#loadingOverlay').hide();
        $('#playBtn').prop('disabled', false);
    }
}

function pauseStream() {
    const player = document.getElementById('videoPlayer');
    player.pause();
    const label = currentStreamLabel || 'Stream';
    updateStreamStatus(`${label} paused`);
}

function stopStream(preserveSelection = false) {
    const player = document.getElementById('videoPlayer');
    player.pause();

    if (hls) {
        // Clear live sync interval if exists
        if (hls.liveSyncInterval) {
            clearInterval(hls.liveSyncInterval);
            hls.liveSyncInterval = null;
        }
        hls.destroy();
        hls = null;
    }

    const request = currentStreamId ? $.ajax({
        url: '/api/streams/stop',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            stream_id: currentStreamId
        })
    }).fail(function(xhr) {
        console.error('Failed to stop stream', xhr.responseJSON || xhr.statusText);
    }) : $.Deferred().resolve().promise();

    return request.always(function() {
        currentStreamId = null;
        player.src = '';
        $('#stopBtn').prop('disabled', true);
        $('#playBtn').prop('disabled', false);
        $('#loadingOverlay').hide();

        if (!preserveSelection) {
            $('#streamsList .list-group-item').removeClass('active');
            currentStream = null;
            currentProfileToken = null;
            currentStreamLabel = null;
            updateStreamStatus('Stream stopped');
        }
    });
}

function updateStreamStatus(message) {
    $('#streamStatus').html(`<small class="text-muted">${message}</small>`);
}

function takeSnapshot() {
    alert('Snapshot functionality would capture current frame');
}

function toggleRecording() {
    isRecording = !isRecording;
    const btn = $('#recordBtn');
    
    if (isRecording) {
        btn.html('<i class="bi bi-stop-circle"></i> Stop Recording');
        btn.removeClass('btn-danger').addClass('btn-warning');
        
        $.post(`/api/cameras/${cameraId}/recordings/start`, function() {
            console.log('Recording started');
        });
    } else {
        btn.html('<i class="bi bi-record-circle"></i> Record');
        btn.removeClass('btn-warning').addClass('btn-danger');
        
        // Would need recording ID to stop
        console.log('Recording stopped');
    }
}

function ptzMove(direction) {
    console.log('PTZ move:', direction);
    alert('PTZ control would move camera: ' + direction);
}

function ptzStop() {
    console.log('PTZ stop');
}

function ptzZoom(direction) {
    console.log('PTZ zoom:', direction);
    alert('PTZ zoom: ' + direction);
}

function gotoPreset() {
    const preset = $('#ptzPresets').val();
    if (preset) {
        console.log('Go to preset:', preset);
        alert('Would move to preset: ' + preset);
    }
}
</script>
{% endblock %}
