{% extends "base.html" %}

{% block title %}Access Control - ONVIF Viewer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h2><i class="bi bi-shield-lock"></i> Access Control (Profiles C & A)</h2>
    </div>
</div>

<div class="row">
    <!-- Access Points -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Access Points</h5>
            </div>
            <div class="card-body">
                <div class="list-group" id="accessPointsList">
                    <!-- Access points will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Peripherals (Profile D) -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Peripherals (Profile D)</h5>
            </div>
            <div class="card-body">
                <div class="list-group" id="peripheralsList">
                    <!-- Peripherals will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recent Access Events</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="accessEventsTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Camera</th>
                                <th>Access Point</th>
                                <th>Event Type</th>
                                <th>Decision</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Events will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    loadAccessPoints();
    loadPeripherals();
    loadAccessEvents();
    setInterval(loadAccessEvents, 5000); // Refresh events every 5 seconds
});

function loadAccessPoints() {
    $.get('/api/access-control', function(accessPoints) {
        const list = $('#accessPointsList');
        list.empty();
        
        if (accessPoints.length === 0) {
            list.html('<p class="text-muted mb-0">No access points configured</p>');
            return;
        }
        
        accessPoints.forEach(ap => {
            const statusClass = ap.status === 'enabled' ? 'success' : 'secondary';
            const item = `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${ap.access_point_name || 'Access Point'}</h6>
                        <span class="badge bg-${statusClass}">${ap.status || 'unknown'}</span>
                    </div>
                    <p class="mb-1"><small class="text-muted">Camera: ${ap.camera_name}</small></p>
                    <small>Type: ${ap.access_point_type || 'N/A'}</small>
                </div>
            `;
            list.append(item);
        });
    });
}

function loadPeripherals() {
    $.get('/api/peripherals', function(peripherals) {
        const list = $('#peripheralsList');
        list.empty();
        
        if (peripherals.length === 0) {
            list.html('<p class="text-muted mb-0">No peripherals detected</p>');
            return;
        }
        
        peripherals.forEach(peripheral => {
            const statusClass = peripheral.status === 'online' ? 'success' : 'secondary';
            const typeIcon = peripheral.peripheral_type === 'Door' ? 'door-closed' : 'gear';
            
            const item = `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">
                            <i class="bi bi-${typeIcon}"></i> ${peripheral.peripheral_name || 'Peripheral'}
                        </h6>
                        <span class="badge bg-${statusClass}">${peripheral.status || 'unknown'}</span>
                    </div>
                    <p class="mb-1"><small class="text-muted">Camera: ${peripheral.camera_name}</small></p>
                    <small>Type: ${peripheral.peripheral_type || 'N/A'}</small>
                </div>
            `;
            list.append(item);
        });
    });
}

function loadAccessEvents() {
    $.get('/api/access-events', function(events) {
        const tbody = $('#accessEventsTable tbody');
        tbody.empty();
        
        if (events.length === 0) {
            tbody.html('<tr><td colspan="6" class="text-center text-muted">No access events recorded</td></tr>');
            return;
        }
        
        events.forEach(event => {
            const time = event.event_time ? new Date(event.event_time).toLocaleString() : 'N/A';
            const decisionClass = event.decision === 'granted' ? 'success' : 
                                event.decision === 'denied' ? 'danger' : 'secondary';
            
            const row = `
                <tr>
                    <td>${time}</td>
                    <td>${event.camera_name || 'Unknown'}</td>
                    <td>${event.access_point_token || 'N/A'}</td>
                    <td><span class="badge bg-info">${event.event_type || 'N/A'}</span></td>
                    <td><span class="badge bg-${decisionClass}">${event.decision || 'N/A'}</span></td>
                    <td>${event.reason || ''}</td>
                </tr>
            `;
            tbody.append(row);
        });
    });
}
</script>
{% endblock %}
