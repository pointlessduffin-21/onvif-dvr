{% extends "base.html" %}

{% block title %}Recordings - ONVIF Viewer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h2><i class="bi bi-record-circle"></i> Recordings</h2>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Search DVR/NVR Recordings (Profile G)</h5>
            </div>
            <div class="card-body">
                <form id="searchForm" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Camera</label>
                        <select class="form-select" id="searchCamera" required>
                            <option value="">Select Camera...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Start Date/Time</label>
                        <input type="datetime-local" class="form-control" id="searchStartTime" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">End Date/Time</label>
                        <input type="datetime-local" class="form-control" id="searchEndTime" required>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Search Results</h5>
            </div>
            <div class="card-body">
                <div id="searchResults">
                    <p class="text-muted text-center">Use the search form above to find recordings on your DVR/NVR</p>
                </div>
                <div class="table-responsive" id="resultsTable" style="display: none;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Recording Token</th>
                                <th>Source/Channel</th>
                                <th>Earliest Recording</th>
                                <th>Latest Recording</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="searchResultsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Recording Summary</h6>
            </div>
            <div class="card-body" id="recordingSummary">
                <p class="text-muted">Select a camera to view recording summary</p>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Quick Searches</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch('today')">
                        <i class="bi bi-calendar-day"></i> Today
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch('yesterday')">
                        <i class="bi bi-calendar-minus"></i> Yesterday
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch('week')">
                        <i class="bi bi-calendar-week"></i> Last 7 Days
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch('month')">
                        <i class="bi bi-calendar-month"></i> Last 30 Days
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Playback Modal -->
<div class="modal fade" id="playbackModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Recording Playback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="ratio ratio-16x9 bg-dark">
                    <video id="playbackPlayer" controls class="w-100">
                        Your browser does not support the video tag.
                    </video>
                </div>
                <div class="mt-3" id="playbackInfo">
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- HLS.js for playback -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
let selectedCamera = null;
let playbackModal = null;

$(document).ready(function() {
    loadCameras();
    playbackModal = new bootstrap.Modal(document.getElementById('playbackModal'));
    
    // Set default date range (last 24 hours)
    const now = new Date();
    const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    
    $('#searchEndTime').val(formatDateTimeLocal(now));
    $('#searchStartTime').val(formatDateTimeLocal(yesterday));
    
    // Handle search form submission
    $('#searchForm').on('submit', function(e) {
        e.preventDefault();
        searchRecordings();
    });
    
    // Handle camera selection change
    $('#searchCamera').on('change', function() {
        const cameraId = $(this).val();
        if (cameraId) {
            loadRecordingSummary(cameraId);
        }
    });
});

function loadCameras() {
    $.get('/api/cameras', function(cameras) {
        const select = $('#searchCamera');
        select.find('option:not(:first)').remove();
        
        cameras.forEach(camera => {
            if (camera.status === 'online') {
                select.append(`<option value="${camera.id}">${camera.name}</option>`);
            }
        });
    });
}

function loadRecordingSummary(cameraId) {
    selectedCamera = cameraId;
    const summaryDiv = $('#recordingSummary');
    summaryDiv.html('<div class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading...</div>');
    
    $.get(`/api/cameras/${cameraId}/recordings/summary`, function(data) {
        if (data.error) {
            summaryDiv.html(`<div class="alert alert-warning mb-0">${data.error}</div>`);
            return;
        }
        
        let html = `
            <div class="mb-3">
                <strong>Total Recordings:</strong> ${data.total_recordings}
            </div>
        `;
        
        if (data.recordings && data.recordings.length > 0) {
            html += '<div class="mb-2"><strong>Recording Sources:</strong></div>';
            html += '<div class="list-group">';
            data.recordings.forEach(rec => {
                html += `
                    <div class="list-group-item list-group-item-action" style="font-size: 0.85rem;">
                        <div><strong>${rec.name || rec.token}</strong></div>
                        <small class="text-muted">Source: ${rec.source || 'N/A'}</small>
                        ${rec.tracks ? `<br><small>Tracks: ${rec.tracks.length}</small>` : ''}
                    </div>
                `;
            });
            html += '</div>';
        }
        
        summaryDiv.html(html);
    }).fail(function() {
        summaryDiv.html('<div class="alert alert-danger mb-0">Failed to load summary</div>');
    });
}

function searchRecordings() {
    const cameraId = $('#searchCamera').val();
    const startTime = $('#searchStartTime').val();
    const endTime = $('#searchEndTime').val();
    
    if (!cameraId) {
        alert('Please select a camera');
        return;
    }
    
    const resultsDiv = $('#searchResults');
    resultsDiv.html('<div class="text-center"><div class="spinner-border"></div><p class="mt-2">Searching recordings...</p></div>');
    $('#resultsTable').hide();
    
    $.ajax({
        url: `/api/cameras/${cameraId}/recordings/search`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            start_time: startTime,
            end_time: endTime
        }),
        success: function(data) {
            if (data.total_results === 0) {
                resultsDiv.html('<div class="alert alert-info">No recordings found in the specified time range</div>');
                return;
            }
            
            resultsDiv.hide();
            $('#resultsTable').show();
            
            const tbody = $('#searchResultsBody');
            tbody.empty();
            
            data.recordings.forEach(rec => {
                const row = `
                    <tr>
                        <td><code>${rec.recording_token}</code></td>
                        <td>${rec.source || 'N/A'}</td>
                        <td>${rec.earliest_recording ? new Date(rec.earliest_recording).toLocaleString() : 'N/A'}</td>
                        <td>${rec.latest_recording ? new Date(rec.latest_recording).toLocaleString() : 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick='playRecording(${cameraId}, "${rec.recording_token}", "${rec.earliest_recording}", "${rec.latest_recording}")'>
                                <i class="bi bi-play-circle"></i> Play
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        },
        error: function(xhr) {
            resultsDiv.html(`<div class="alert alert-danger">Search failed: ${xhr.responseJSON?.error || 'Unknown error'}</div>`);
        }
    });
}

function quickSearch(period) {
    const now = new Date();
    let startDate;
    
    switch(period) {
        case 'today':
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            break;
        case 'yesterday':
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
            now.setDate(now.getDate() - 1);
            now.setHours(23, 59, 59);
            break;
        case 'week':
            startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            break;
        case 'month':
            startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            break;
    }
    
    $('#searchStartTime').val(formatDateTimeLocal(startDate));
    $('#searchEndTime').val(formatDateTimeLocal(now));
    
    if ($('#searchCamera').val()) {
        searchRecordings();
    }
}

function playRecording(cameraId, recordingToken, startTime, endTime) {
    $('#playbackInfo').html('<div class="spinner-border spinner-border-sm"></div> Getting playback URL...');
    playbackModal.show();
    
    $.ajax({
        url: '/api/recordings/playback-uri',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            camera_id: cameraId,
            recording_token: recordingToken,
            start_time: startTime,
            end_time: endTime
        }),
        success: function(data) {
            if (data.success) {
                $('#playbackInfo').html(`
                    <strong>Recording:</strong> ${recordingToken}<br>
                    <strong>Time Range:</strong> ${new Date(startTime).toLocaleString()} - ${new Date(endTime).toLocaleString()}<br>
                    <strong>Stream URI:</strong> <code>${data.uri}</code><br>
                    <small class="text-muted">Note: This RTSP stream can be converted to HLS for playback in browser</small>
                `);
                
                // For now, show the RTSP URL
                // In production, you'd convert this to HLS like live streams
                const video = document.getElementById('playbackPlayer');
                // video.src would be HLS URL after conversion
                console.log('Recording RTSP URI:', data.uri);
            } else {
                $('#playbackInfo').html('<div class="alert alert-danger">Failed to get playback URL</div>');
            }
        },
        error: function(xhr) {
            $('#playbackInfo').html(`<div class="alert alert-danger">Error: ${xhr.responseJSON?.error || 'Unknown error'}</div>`);
        }
    });
}

function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}


</script>
{% endblock %}
