{% extends "base.html" %}

{% block title %}DVRs - ONVIF DVR Viewer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4 gap-3">
    <h2 class="mb-0"><i class="bi bi-hdd"></i> DVR Management</h2>
        <div class="btn-group" role="group">
            <button class="btn btn-outline-secondary" id="refreshCamerasBtn">
                <i class="bi bi-arrow-clockwise"></i> Refresh DVR Streams
            </button>
            <a class="btn btn-outline-info" href="/grid">
                <i class="bi bi-grid-3x3-gap"></i> Grid View
            </a>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCameraModal">
                <i class="bi bi-plus-circle"></i> Add DVR
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="camerasTable">
                        <thead>
                            <tr>
                                <th>DVR Name</th>
                                <th>Host</th>
                                <th>Manufacturer</th>
                                <th>Model</th>
                                <th>Status</th>
                                <th>Streams</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- DVRs will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add DVR Modal -->
<div class="modal fade" id="addCameraModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add ONVIF DVR</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body position-relative">
                <!-- Loading Overlay -->
                <div id="addCameraLoadingOverlay" class="position-absolute top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center" style="background: rgba(255, 255, 255, 0.9); z-index: 1050; border-radius: 0.375rem;">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="fw-bold">Connecting to DVR...</div>
                        <div class="text-muted small mt-2">This may take a few seconds</div>
                    </div>
                </div>
                
                <form id="addCameraForm">
                    <div class="mb-3">
                        <label for="cameraName" class="form-label">DVR Name</label>
                        <input type="text" class="form-control" id="cameraName" required>
                    </div>
                    <div class="mb-3">
                        <label for="cameraHost" class="form-label">IP Address / Host</label>
                        <input type="text" class="form-control" id="cameraHost" required>
                    </div>
                    <div class="mb-3">
                        <label for="cameraPort" class="form-label">Port</label>
                        <input type="number" class="form-control" id="cameraPort" value="80" required>
                    </div>
                    <div class="mb-3">
                        <label for="cameraUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="cameraUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="cameraPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="cameraPassword" required>
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <strong>Supported Profiles:</strong> S (Streaming), G (Recording), 
                            C (Physical Access), A (Access Control), T (Advanced Streaming), 
                            M (Metadata/Events), D (Peripherals)
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="addCameraCancelBtn" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="addCameraSubmitBtn" onclick="addCamera()">
                    <i class="bi bi-plus-circle"></i> Add DVR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit DVR Modal -->
<div class="modal fade" id="editCameraModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit DVR</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCameraForm">
                    <input type="hidden" id="editCameraId">
                    <div class="mb-3">
                        <label for="editCameraName" class="form-label">DVR Name</label>
                        <input type="text" class="form-control" id="editCameraName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCameraHost" class="form-label">IP Address / Host</label>
                        <input type="text" class="form-control" id="editCameraHost" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCameraPort" class="form-label">Port</label>
                        <input type="number" class="form-control" id="editCameraPort" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCameraUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editCameraUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCameraPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="editCameraPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateCamera()">
                    <i class="bi bi-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    loadCameras();
    
    $('#refreshCamerasBtn').on('click', function() {
        refreshCameras();
    });

    // Fix modal backdrop z-index issues
    $('#addCameraModal, #editCameraModal').on('show.bs.modal', function() {
        // Ensure modal and backdrop have correct z-index
        setTimeout(() => {
            $(this).css('z-index', 1060);
            $('.modal-backdrop').css('z-index', 1055);
        }, 0);
    });
    
    // Clean up any orphaned backdrops on modal hide
    $('#addCameraModal, #editCameraModal').on('hidden.bs.modal', function() {
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        
        // Reset forms when modal is closed
        $('#addCameraForm')[0].reset();
        $('#editCameraForm')[0].reset();
        
        // Reset loading state for add camera modal
        const loadingOverlay = $('#addCameraLoadingOverlay');
        const submitBtn = $('#addCameraSubmitBtn');
        const cancelBtn = $('#addCameraCancelBtn');
        const formInputs = $('#addCameraForm input, #addCameraForm button');
        
        if (loadingOverlay.length) {
            loadingOverlay.addClass('d-none').removeClass('d-flex');
            submitBtn.prop('disabled', false);
            cancelBtn.prop('disabled', false);
            formInputs.prop('disabled', false);
            
            // Remove any error alerts
            $('#addCameraForm').next('.alert').remove();
        }
    });
});

function escapeHtml(text) {
    if (text === null || text === undefined) {
        return '';
    }
    return $('<div>').text(text).html();
}

function loadCameras() {
    $.get('/api/cameras', function(cameras) {
        const tbody = $('#camerasTable tbody');
        tbody.empty();
        
        cameras.forEach(camera => {
            const streamLabels = Array.isArray(camera.stream_labels) ? camera.stream_labels : [];
            const streamCount = typeof camera.stream_count === 'number' ? camera.stream_count : streamLabels.length;
            const badgeLimit = 3;
            const streamBadges = streamLabels.slice(0, badgeLimit).map(label =>
                `<span class="badge bg-secondary me-1">${escapeHtml(label)}</span>`
            ).join('');
            const remaining = streamLabels.length - badgeLimit;
            const extraBadge = remaining > 0 ? `<span class="badge bg-light text-dark border">+${remaining}</span>` : '';
            const streamSummaryText = streamCount > 0 
                ? `${streamCount} stream${streamCount === 1 ? '' : 's'}`
                : 'No streams';
            
            const row = `
                <tr class="camera-row" data-camera-id="${camera.id}">
                    <td>${camera.name}</td>
                    <td>${camera.host}:${camera.port}</td>
                    <td>${camera.manufacturer || 'N/A'}</td>
                    <td>${camera.model || 'N/A'}</td>
                    <td>
                        <span class="badge ${camera.status === 'online' ? 'bg-success' : 'bg-secondary'}">
                            ${camera.status}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex flex-wrap align-items-center gap-1">
                            ${streamBadges}${extraBadge}
                        </div>
                        <small class="text-muted d-block">${streamSummaryText}</small>
                    </td>
                    <td>
                        <a href="/viewer/${camera.id}" class="btn btn-sm btn-primary action-btn" title="View">
                            <i class="bi bi-play-circle"></i>
                        </a>
                        <button class="btn btn-sm btn-warning action-btn" onclick="editCamera(${camera.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger action-btn" onclick="deleteCamera(${camera.id})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });

        $('#camerasTable tbody').off('click', 'tr.camera-row').on('click', 'tr.camera-row', function(event) {
            if ($(event.target).closest('.action-btn').length) {
                return;
            }
            const cameraId = $(this).data('camera-id');
            window.location.href = `/viewer/${cameraId}`;
        });
    });
}

function setRefreshButtonState(isLoading) {
    const button = $('#refreshCamerasBtn');
    if (isLoading) {
        if (!button.data('original-text')) {
            button.data('original-text', button.html());
        }
        button.prop('disabled', true).html(`
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Refreshing...
        `);
    } else {
        const original = button.data('original-text');
        if (original) {
            button.html(original);
        }
        button.prop('disabled', false);
    }
}

function refreshCameras() {
    setRefreshButtonState(true);
    $.ajax({
        url: '/api/cameras/refresh',
        method: 'POST',
        success: function(response) {
            const refreshedCount = response.refreshed ? response.refreshed.length : 0;
            const errorCount = response.errors ? response.errors.length : 0;
            const totalStreams = response.total_streams || 0;
            let message = `Refreshed ${totalStreams} stream${totalStreams === 1 ? '' : 's'} across ${refreshedCount} DVR${refreshedCount === 1 ? '' : 's'}.`;
            if (errorCount > 0) {
                message += ` ${errorCount} DVR${errorCount === 1 ? ' has' : 's have'} errors.`;
            }
            alert(message);
            loadCameras();
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            const error = response && response.errors ? JSON.stringify(response.errors) : 'Unable to refresh DVRs.';
            alert(error);
        },
        complete: function() {
            setRefreshButtonState(false);
        }
    });
}

function addCamera() {
    // Validate form
    const form = document.getElementById('addCameraForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const data = {
        name: $('#cameraName').val(),
        host: $('#cameraHost').val(),
        port: parseInt($('#cameraPort').val()),
        username: $('#cameraUsername').val(),
        password: $('#cameraPassword').val()
    };
    
    // Show loading overlay
    const loadingOverlay = $('#addCameraLoadingOverlay');
    const submitBtn = $('#addCameraSubmitBtn');
    const cancelBtn = $('#addCameraCancelBtn');
    const formInputs = $('#addCameraForm input, #addCameraForm button');
    
    loadingOverlay.removeClass('d-none').addClass('d-flex');
    submitBtn.prop('disabled', true);
    cancelBtn.prop('disabled', true);
    formInputs.prop('disabled', true);
    
    // Update loading message
    const loadingText = loadingOverlay.find('.fw-bold');
    const loadingSubtext = loadingOverlay.find('.text-muted');
    
    // Start connection attempt
    loadingText.text('Connecting to DVR...');
    loadingSubtext.text('Trying vendor-specific connection methods...');
    
    $.ajax({
        url: '/api/cameras',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        timeout: 30000, // 30 second timeout
        success: function(response) {
            loadingText.text('Success!');
            loadingSubtext.text('Saving DVR configuration...');
            
            // Small delay to show success message
            setTimeout(function() {
                $('#addCameraModal').modal('hide');
                $('#addCameraForm')[0].reset();
                loadCameras();
                
                // Show success notification
                const alertDiv = $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                    '<strong>Success!</strong> DVR "' + data.name + '" has been added successfully.' +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                    '</div>');
                $('.container-fluid').first().prepend(alertDiv);
                
                // Auto-dismiss after 5 seconds
                setTimeout(function() {
                    alertDiv.alert('close');
                }, 5000);
            }, 500);
        },
        error: function(xhr) {
            let errorMsg = 'Failed to add DVR';
            let errorDetails = '';
            
            if (xhr.responseJSON) {
                errorMsg = xhr.responseJSON.error || errorMsg;
                errorDetails = xhr.responseJSON.details || '';
            } else if (xhr.status === 0) {
                errorMsg = 'Connection timeout or network error';
                errorDetails = 'Please check your network connection and try again.';
            } else if (xhr.status === 400) {
                errorMsg = 'Invalid request';
                errorDetails = 'Please check all fields are filled correctly.';
            } else if (xhr.status === 500) {
                errorMsg = 'Server error';
                errorDetails = 'An error occurred on the server. Please try again.';
            }
            
            // Hide loading overlay
            loadingOverlay.addClass('d-none').removeClass('d-flex');
            submitBtn.prop('disabled', false);
            cancelBtn.prop('disabled', false);
            formInputs.prop('disabled', false);
            
            // Show error alert
            const errorAlert = $('<div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">' +
                '<strong>Error:</strong> ' + errorMsg +
                (errorDetails ? '<br><small>' + errorDetails + '</small>' : '') +
                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                '</div>');
            $('#addCameraForm').after(errorAlert);
            
            // Auto-dismiss after 10 seconds
            setTimeout(function() {
                errorAlert.alert('close');
            }, 10000);
        },
        beforeSend: function() {
            // Update status messages during connection
            setTimeout(function() {
                if (loadingOverlay.hasClass('d-flex')) {
                    loadingText.text('Connecting to DVR...');
                    loadingSubtext.text('Attempting ONVIF connection...');
                }
            }, 2000);
        }
    });
}

function editCamera(id) {
    $.get(`/api/cameras/${id}`, function(camera) {
        $('#editCameraId').val(camera.id);
        $('#editCameraName').val(camera.name);
        $('#editCameraHost').val(camera.host);
        $('#editCameraPort').val(camera.port);
        $('#editCameraUsername').val(camera.username);
        $('#editCameraPassword').val(camera.password);
        $('#editCameraModal').modal('show');
    });
}

function updateCamera() {
    const id = $('#editCameraId').val();
    const data = {
        name: $('#editCameraName').val(),
        host: $('#editCameraHost').val(),
        port: parseInt($('#editCameraPort').val()),
        username: $('#editCameraUsername').val(),
        password: $('#editCameraPassword').val()
    };
    
    $.ajax({
        url: `/api/cameras/${id}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function() {
            $('#editCameraModal').modal('hide');
            loadCameras();
            alert('DVR updated successfully!');
        },
        error: function() {
            alert('Failed to update DVR');
        }
    });
}

function deleteCamera(id) {
    if (confirm('Are you sure you want to delete this DVR?')) {
        $.ajax({
            url: `/api/cameras/${id}`,
            method: 'DELETE',
            success: function() {
                loadCameras();
                alert('DVR deleted successfully!');
            },
            error: function() {
                alert('Failed to delete DVR');
            }
        });
    }
}
</script>
{% endblock %}
